import{a as Ee,b as W,c as Oe,d as Le,e as qe,f as Ue,k as je}from"./chunk-U3ZSWC23.js";import{g as Ce}from"./chunk-W3XNXTU3.js";import{a as _e,d as Se,e as we,h as De}from"./chunk-LMRVNFCC.js";import{a as re}from"./chunk-YKK6WNC6.js";import{A as x,Aa as te,Ab as ce,Ca as ie,Db as ue,Fa as oe,Gb as de,Hb as be,I as z,Ib as pe,Jb as ge,K as d,Kb as fe,L as S,Lb as he,Mb as Be,Nb as Me,Ob as xe,Pb as ve,Q as w,Qb as Te,R as b,W as u,X as p,Y as y,aa as Z,ab as n,ba as L,c as T,ca as f,ea as G,f as _,fa as K,fb as a,g as E,ga as Y,gb as A,gc as ye,ha as q,hb as V,hc as Ae,ia as D,ja as J,jc as Ie,ka as X,l as g,m as P,ma as U,na as j,oa as F,ob as H,p as O,s as B,sb as ne,u as Q,ua as N,va as R,vb as le,wa as ee,wb as se,xb as ae,z as M,zb as me}from"./chunk-EDS3JHJR.js";import{i as s}from"./chunk-GV7GV3NK.js";var c=class extends A{id;annee;monnaie;image;imageTable;imageZoom;timbreBlocAcquisModel;constructor(e,t,i,o,l,m,v){super(),this.id=e||null,this.annee=t||null,this.monnaie=i||null,this.image=o||null,this.imageTable=l||null,this.imageZoom=m||null,this.timbreBlocAcquisModel=v||null}getId(){return this.id}setId(e){this.id=e}getAnnee(){return this.annee}setAnnee(e){this.annee=e}getMonnaie(){return this.monnaie}setMonnaie(e){this.monnaie=e}getImage(){return this.image}setImage(e){this.image=e}getImageTable(){return this.imageTable}setImageTable(e){this.imageTable=e}getImageZoom(){return this.imageZoom}setImageZoom(e){this.imageZoom=e}getTimbreBlocAcquisModel(){return this.timbreBlocAcquisModel}setTimbreBlocAcquisModel(e){this.timbreBlocAcquisModel=e}};s([a("Identifiant")],c.prototype,"id",2),s([a("Ann\xE9e")],c.prototype,"annee",2),s([a("Monnaie")],c.prototype,"monnaie",2),s([a("Image")],c.prototype,"image",2),s([a("Image tableau")],c.prototype,"imageTable",2),s([a("Image zoom")],c.prototype,"imageZoom",2),s([a("v\xE9rif")],c.prototype,"timbreBlocAcquisModel",2);var h=class extends A{idUser;idBloc;acquis;doublon;constructor(e,t,i,o){super(),this.idUser=e||null,this.idBloc=t||null,this.acquis=i||!1,this.doublon=o||!1}getIdUser(){return this.idUser}setIdUser(e){this.idUser=e}getIdBloc(){return this.idBloc}setIdBloc(e){this.idBloc=e}isAcquis(){return this.acquis}setAcquis(e){this.acquis=e}isDoublon(){return this.doublon}setDoublon(e){this.doublon=e}};s([a("Identifiant Utilisateur")],h.prototype,"idUser",2),s([a("Identifiant bloc")],h.prototype,"idBloc",2),s([a("Acquis")],h.prototype,"acquis",2),s([a("Doublon")],h.prototype,"doublon",2);var k=class r{constructor(e,t,i,o){this.firestore=e;this.authService=t;this.uploadService=i;this.utilsService=o}heigthTable=50;widthTimbre=100;heightTimbre=100;widthTimbreZoom=500;heightTimbreZoom=500;total$=new T(0);timbresBlocModel$=new T(null);upload(e,t){let i=this.widthTimbre,o=this.heightTimbre;return t=="table"?(i=i*(this.heigthTable/o),o=this.heigthTable):t=="zoom"&&(i=i*(this.heightTimbreZoom/o),o=this.heightTimbreZoom),this.uploadService.processAndUploadImage(e?.getImage(),i,o,"bloc",this.getDossier(e,t))}getTotal(e){this.total$.next(null),this.getAllBlocs(e).pipe(g()).subscribe(t=>{this.total$.next(t?.length)})}getBlocByIdAsync(e){return this.firestore.collection("/timbres_bloc",t=>t.where("id","==",e)).valueChanges().pipe(_(t=>V(c,t[0])))}getAllBlocs(e){return this.firestore.collection("/timbres_bloc",t=>{let i=t;return n(e)&&n(e.getAnnees())&&e.getAnnees()?.length>0&&(i=i.where("annee","in",e.getAnnees())),i}).valueChanges()}getTimbreBlocAcquis(){return this.authService.getUser().pipe(g(),P(e=>n(e)?this.getTimbreBlocAcquisByUser(e.getId()).pipe(g(),_(t=>t)):null))}getTimbreBlocAcquisByUser(e){return this.firestore.collection("/timbres_bloc_acquis",t=>t.where("idUser","==",e)).valueChanges()}getBlocs(e){this.getTotal(),this.timbresBlocModel$.next(null),E([this.getAllBlocs(e),this.getTimbreBlocAcquis()]).pipe(g()).subscribe(([t,i])=>{this.constructBlocs(t,i,e)})}getBlocsAsync(e){return this.getTotal(),this.timbresBlocModel$.next(null),this.getAllBlocs(e).pipe(g(),_(t=>this.constructBlocs(t,null,e)))}constructBloc(e,t){let i=V(c,e);if(n(t)){let o=t.find(l=>l.idBloc==i.getId());n(o)?i.setTimbreBlocAcquisModel(V(h,o)):i.setTimbreBlocAcquisModel(new h)}return i}constructBlocs(e,t,i){let o=[];return e?.length>0&&e.forEach(l=>{let m=this.constructBloc(l,t),v=!0;n(i)&&(n(i.getAcquis())&&!(i.getAcquis()=="TOUS"||i.getAcquis()=="OUI"&&m.getTimbreBlocAcquisModel().isAcquis()||i.getAcquis()=="NON"&&!m.getTimbreBlocAcquisModel().isAcquis())&&(v=!1),n(i.getDoublon())&&!(i.getDoublon()=="TOUS"||i.getDoublon()=="OUI"&&m.getTimbreBlocAcquisModel().isDoublon()||i.getDoublon()=="NON"&&!m.getTimbreBlocAcquisModel().isDoublon())&&(v=!1)),v==!0&&o.push(m)}),this.timbresBlocModel$.next(o),o}acquis(e,t){return this.authService.getUser().pipe(g(i=>n(i))).subscribe(i=>{if(n(e?.getTimbreBlocAcquisModel()?.getIdUser()))this.firestore.collection("/timbres_bloc_acquis").ref.where("idTimbre","==",e.getId()).where("idUser","==",i.getId()).get().then(o=>{o.forEach(l=>{let m=e.getTimbreBlocAcquisModel();t?(m.setAcquis(!0),m.setDoublon(!m.isDoublon())):(m.setAcquis(!m.isAcquis()),m.isAcquis()||m.setDoublon(!1)),l.ref.update(Object.assign(new Object,m))})}).catch(o=>{console.error("Erreur de mise \xE0 jour:",o)});else{let o=new h;o.setIdUser(i.getId()),o.setIdBloc(e.getId()),o.setAcquis(!0),o.setDoublon(t),e.setTimbreBlocAcquisModel(o),this.firestore.collection("/timbres_bloc_acquis").add(Object.assign(new Object,o))}})}ajouterSansId(e){this.utilsService.getMaxIdentAsync("/timbres_bloc").pipe(g()).subscribe(t=>{e.setId(t),this.ajouter(e)})}ajouter(e){this.firestore.collection("/timbres_bloc").add(Object.assign(new Object,e)),this.getBlocs()}modifier(e){this.firestore.collection("/timbres_bloc").ref.where("id","==",e.getId()).get().then(t=>{t.forEach(i=>{i.ref.update(Object.assign(new Object,e)),this.getBlocs()})}).catch(t=>{console.error("Erreur de mise \xE0 jour:",t)})}supprimer(e){this.firestore.collection("/timbres_bloc").ref.where("id","==",e.getId()).get().then(t=>{t.forEach(i=>{i.ref.delete(),this.getBlocs()})}).catch(t=>{console.error("Erreur de suppression :",t)})}getDossier(e,t){let i="timbre//"+e.getAnnee();return n(t)&&(i=i+"/"+t),i=i+"/bloc/"+e.getId(),i}getBouchon(){let e=new c;return e.setAnnee(new Date().getFullYear()),e.setMonnaie("E"),e}static \u0275fac=function(t){return new(t||r)(B(H),B(re),B(Ee),B(W))};static \u0275prov=O({token:r,factory:r.\u0275fac})};var Ne=class r{constructor(e){this.firestore=e}getAnneesAsync(e){return this.firestore.collection(e,t=>{let i=t;return i=i.orderBy("annee","desc"),i}).valueChanges().pipe(_(t=>{let i=t.map(o=>Number(o.annee)).filter(o=>n(o)&&o!=0);return Array.from(new Set(i))}))}static \u0275fac=function(t){return new(t||r)(B(H))};static \u0275prov=O({token:r,factory:r.\u0275fac})};var $=class{dossier;nom;alignLabel;detail;file;getDossier(){return this.dossier}setDossier(e){this.dossier=e}getNom(){return this.nom}setNom(e){this.nom=e}getAlignLabel(){return this.alignLabel}setAlignLabel(e){this.alignLabel=e}getDetail(){return this.detail}setDetail(e){this.detail=e}getFile(){return this.file}setFile(e){this.file=e}};var C=class{key;dossier;maxWidth;maxHeight;getKey(){return this.key}setKey(e){this.key=e}getDossier(){return this.dossier}setDossier(e){this.dossier=e}getMaxWidth(){return this.maxWidth}setMaxWidth(e){this.maxWidth=e}getMaxHeight(){return this.maxHeight}setMaxHeight(e){this.maxHeight=e}};var Ze=["canvas"];function Pe(r,e){r&1&&y(0,"lib-spinner",5),r&2&&b("textSpec","Chargement en cours ...")}function Qe(r,e){if(r&1&&(y(0,"mat-error",18),N(1,"async")),r&2){let t=f(2);b("innerHTML",R(1,1,t.messageError$),z)}}function ze(r,e){if(r&1){let t=Z();u(0,"div",10)(1,"label"),y(2,"lib-libelle-model",11),p(),u(3,"input",19),F("ngModelChange",function(o){M(t);let l=f(2);return j(l.timbreBlocModel.id,o)||(l.timbreBlocModel.id=o),x(o)}),p()()}if(r&2){let t=f(2);d(2),b("object",t.timbreBlocModel)("key","id"),d(),U("ngModel",t.timbreBlocModel.id),b("disabled",!!(t.timbreBlocModel!=null&&t.timbreBlocModel.getId()))}}function Ge(r,e){if(r&1){let t=Z();u(0,"form",6,1),L("ngSubmit",function(){M(t);let o=q(1),l=f();return x(l.valider(o))}),u(2,"div",7),w(3,Qe,2,3,"mat-error",8),N(4,"async"),w(5,ze,4,4,"div",9),u(6,"div",10)(7,"label"),y(8,"lib-libelle-model",11),p(),u(9,"input",12),F("ngModelChange",function(o){M(t);let l=f();return j(l.timbreBlocModel.annee,o)||(l.timbreBlocModel.annee=o),x(o)}),p()(),u(10,"div",10)(11,"label"),y(12,"lib-libelle-model",11),p(),u(13,"input",13),F("ngModelChange",function(o){M(t);let l=f();return j(l.timbreBlocModel.monnaie,o)||(l.timbreBlocModel.monnaie=o),x(o)}),p()(),u(14,"lib-upload",14),L("outPutObject",function(o){M(t);let l=f();return x(l.timbreBlocModel=o)}),p()(),u(15,"div",15)(16,"button",16),L("click",function(){M(t);let o=f();return x(o.close())}),D(17," Annuler "),p(),u(18,"button",17),D(19," Enregistrer "),p()()()}if(r&2){let t=q(1),i=f();b("ngClass",t!=null&&t.submitted?"red-color":"blue-color"),d(3),b("ngIf",R(4,15,i.messageError$)),d(2),b("ngIf",i.timbreBlocModel==null?null:i.timbreBlocModel.getId()),d(3),b("object",i.timbreBlocModel)("key","annee"),d(),U("ngModel",i.timbreBlocModel.annee),b("max",i.maxAnnee)("zMax",i.maxAnnee),d(3),b("object",i.timbreBlocModel)("key","monnaie"),d(),U("ngModel",i.timbreBlocModel.monnaie),d(),b("object",i.timbreBlocModel)("key","image")("maxWidth",i.timbreBlocService.widthTimbre)("maxHeight",i.timbreBlocService.heightTimbre)}}var Re=class r{constructor(e,t,i,o){this.httpResponseHandlerService=e;this.dialogRef=t;this.utilsService=i;this.timbreBlocService=o}canvas;messageError$=new T(null);load$=new T(null);id;maxAnnee=new Date().getFullYear();timbreBlocModel=new c;fileUploadModel=new $;ngOnInit(){this.initUpload(),this.load$.next(!1),n(this.id)?this.timbreBlocService.getBlocByIdAsync(this.id).subscribe(e=>{this.timbreBlocModel=e,this.load$.next(!0)}):(this.timbreBlocModel.setAnnee(new Date().getFullYear()),this.timbreBlocModel.setMonnaie("E"),this.load$.next(!0))}initUpload(){this.fileUploadModel.setDossier("test"),this.fileUploadModel.setNom(new Date().getTime()?.toString());let e=new C;e.setMaxWidth(this.timbreBlocService.widthTimbre),e.setMaxHeight(this.timbreBlocService.heightTimbre),e.setDossier("autre");let t=new C;t.setMaxWidth(this.timbreBlocService.widthTimbreZoom),t.setMaxHeight(this.timbreBlocService.heightTimbreZoom),t.setDossier("zoom"),this.fileUploadModel.setDetail([e,t])}valider(e){if(this.messageError$.next(null),e?.valid)if(n(this.timbreBlocModel.getImage()))this.saveData();else{this.messageError$.next("Veuillez s\xE9lectionner une image");return}}saveData(){this.load$.next(!1),n(this.timbreBlocModel.getId())?this.save():this.ajouter()}ajouter(){this.utilsService.getMaxIdentAsync("/timbres_bloc").pipe(g()).subscribe(e=>{this.timbreBlocModel.setId(e),this.save(!0)})}save(e){try{E([this.timbreBlocService.upload(this.timbreBlocModel,"autre"),this.timbreBlocService.upload(this.timbreBlocModel,"table"),this.timbreBlocService.upload(this.timbreBlocModel,"zoom")]).pipe(g(([t,i,o])=>n(t)&&n(o)&&n(i))).subscribe(([t,i,o])=>{n(i)&&i!="nok"&&this.timbreBlocModel.setImage(i),n(t)&&t!="nok"&&this.timbreBlocModel.setImageTable(t),n(o)&&o!="nok"&&this.timbreBlocModel.setImageZoom(o),e?this.timbreBlocService.ajouter(this.timbreBlocModel):this.timbreBlocService.modifier(this.timbreBlocModel),this.httpResponseHandlerService.showNotificationSuccess("Transaction termin\xE9e","Votre timbre a bien \xE9t\xE9 modifi\xE9e."),this.load$.next(!0),this.dialogRef.close()})}catch{this.httpResponseHandlerService.showNotificationError("Transaction non aboutie","Votre timbre n'a pas pu \xEAtre modifi\xE9."),this.load$.next(!0)}}close(){this.dialogRef.close()}static \u0275fac=function(t){return new(t||r)(S(Ce),S(Ie),S(W),S(k))};static \u0275cmp=Q({type:r,selectors:[["app-timbre-modifier-bloc"]],viewQuery:function(t,i){if(t&1&&G(Ze,5),t&2){let o;K(o=Y())&&(i.canvas=o.first)}},decls:10,vars:6,consts:[["load",""],["formModif","ngForm"],["fxFlexFill","","fxLayout","column","fxLayoutAlign","space-between stretch",1,"dialog-modal"],["fxLayout","row","fxLayoutGap","5px","fxLayoutAlign","start center",1,"titre-modal","bg-primary","color-white"],[3,"ngIf","ngIfElse"],["fxFlexFill","",3,"textSpec"],["ngForm","formModif","fxLayoutGap","20px","fxFlex","100","fxLayout","column","fxLayoutAlign","space-between stretch",1,"formulaire-box-elevation",3,"ngSubmit","ngClass"],["fxLayout","column","fxLayoutGap","20px",1,"bloc-modal"],[3,"innerHTML",4,"ngIf"],["fxLayout","column","class","form-input",4,"ngIf"],["fxLayout","column",1,"form-input"],[3,"object","key"],["name","page","type","number","minlength","4","maxlength","4","min","1900","zMin","1900","required","","zControl","",1,"annee",2,"width","60px !important",3,"ngModelChange","ngModel","max","zMax"],["name","monnaie","type","text","trim","","minlength","1","maxlength","2","required","","zControl","",2,"width","25px !important",3,"ngModelChange","ngModel"],[3,"outPutObject","object","key","maxWidth","maxHeight"],["fxLayout","row","fxLayoutGap","10px","fxLayoutAlign","end end",1,"bloc-bouton-modal"],["type","button","mat-raised-button","","color","primary",1,"rounded","large","color-white",3,"click"],["type","submit","mat-raised-button","","color","accent",1,"rounded","large","color-white"],[3,"innerHTML"],["name","code","type","text","trim","","upperCase","","noEspace","","required","","zControl","",3,"ngModelChange","ngModel","disabled"]],template:function(t,i){if(t&1&&(u(0,"div",2)(1,"div",3)(2,"span"),D(3),p(),u(4,"span"),D(5),p()(),w(6,Pe,1,1,"ng-template",4),N(7,"async"),w(8,Ge,20,17,"ng-template",null,0,ee),p()),t&2){let o=q(9);d(3),X("",i.timbreBlocModel!=null&&i.timbreBlocModel.getId()?"MODIFICATION":"AJOUT"," BLOC "),d(2),J(i.timbreBlocModel==null?null:i.timbreBlocModel.getId()),d(),b("ngIf",R(7,4,i.load$)==!1)("ngIfElse",o)}},dependencies:[Ae,ye,te,ie,le,se,ce,me,ae,ne,fe,ue,he,de,be,xe,ve,Te,Me,Be,ge,pe,De,we,_e,Se,Oe,Le,qe,je,Ue,oe],encapsulation:2})};var I=class extends A{annees;acquis;doublon;bloc;getAnnees(){return this.annees}setAnnees(e){this.annees=e}getAcquis(){return this.acquis}setAcquis(e){this.acquis=e}getDoublon(){return this.doublon}setDoublon(e){this.doublon=e}getBloc(){return this.bloc}setBloc(e){this.bloc=e}};s([a("Ann\xE9e")],I.prototype,"annees",2),s([a("Acquis")],I.prototype,"acquis",2),s([a("Doublon")],I.prototype,"doublon",2),s([a("Bloc")],I.prototype,"bloc",2);export{$ as a,C as b,I as c,c as d,h as e,k as f,Ne as g,Re as h};
